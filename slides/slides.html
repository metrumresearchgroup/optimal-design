<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>A Gentle Introduction to Optimal Design for Pharmacometric Models</title>
    <meta charset="utf-8" />
    <meta name="author" content="Tim Waterhouse" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
    <script src="libs/kePrint/kePrint.js"></script>
    <link rel="stylesheet" href="tweaks.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">






class: title-slide   

# A Gentle Introduction to Optimal Design &lt;br/&gt; for Pharmacometric Models
## with PopED and mrgsolve

## Tim Waterhouse &lt;br/&gt; Metrum Research Group
## 8 June, 2020

---


layout: true

&lt;div class="my-footer"&gt;&lt;/div&gt;       

&lt;style type="text/css"&gt;
pre {
  #background: #FFBB33;
  max-width: 100%;
  overflow-x: scroll;
}
&lt;/style&gt;

---

background-image: linear-gradient(90deg, rgba(255,255,255,1) 50%, rgba(0,0,0,0) 70%), url(https://live.staticflickr.com/4422/36449778360_8683e16f7f_k_d.jpg)
background-size: cover
  
# Why are we here?

--

.pull-left[
* You want to design a study
{{content}}
]

--

* You'll be fitting a model to the results
{{content}}

--

* You don't want that model to fail spectacularly
{{content}}

--

* You don't have the time or the patience to run a bunch of simulations
{{content}}


???

Image credit: [Flickr](https://www.flickr.com/photos/18378305@N00/36449778360)

---

background-image: linear-gradient(90deg, rgba(255,255,255,1) 50%, rgba(0,0,0,0) 70%), url(https://live.staticflickr.com/35/70342823_cd9f9ec744_h_d.jpg)
background-size: cover
  
# Outline

* Optimal design background

--

* Software tools

--

* Simple model with `PopED`
    + Evaluation
    + Optimization
    + Simulation

--

* More complex models with `PopED` and `mrgsolve`

???

Image credit: [Flickr](https://www.flickr.com/photos/davidden/70342823/)

---

background-image: linear-gradient(90deg, rgba(255,255,255,1) 50%, rgba(0,0,0,0) 70%), url(https://live.staticflickr.com/3061/2599260050_539b8904c7_k_d.jpg)
background-size: cover
  
# Acknowledgements

.pull-left[
* Kyle Baron

* Devin Pastoor
]

???

Image credit: [Flickr](https://www.flickr.com/photos/tinahesmansaey/2599260050)

---

class: poll-slide

# Poll Question #1

## What is your experience with optimal design?

1. Never heard of it.

--

2. I've seen it around, and I'd like to try it.

--

3. I've seen it around, but it seems kinda dodgy.

--

4. I've used optimal design for some studies.

--

5. I invert Fisher information matrices in my head.

--

6. Huh? Sorry, I was checking email.
---

class: inverse, center, middle

# Optimal design background

---

# Meet the Fisher information matrix (FIM)

.pull-left[
$$ M_F(\mathbf{\Psi},\xi)
= - \operatorname{E}
\left[\left.
 \frac{\partial^2}{\partial\mathbf{\Psi} \partial\mathbf{\Psi}^T} \log L(\mathbf{\Psi};y)
\right|\mathbf{\Psi}\right] $$

where

* `\(\mathbf{\Psi}\)` is the vector of populations parameters (e.g. `THETA`s, `OMEGA`s, and `SIGMA`s in NONMEM),

* `\(y\)` is the vector of observations,

* `\(\xi\)` is the vector of design variables (e.g. sampling times), and

* `\(\log L\)` is the log-likelihood.
]

.pull-right[
![](https://upload.wikimedia.org/wikipedia/commons/0/09/Fisher-face-snow_-_West_Virginia_-_ForestWander.jpg)&lt;!-- --&gt;
.font-70[Fisher in winter coat]
]

???

Image credit: https://commons.wikimedia.org/wiki/File:Fisher-face-teeth-snow_-_West_Virginia_-_ForestWander.jpg

---

# Why should I care about that thing?

[Cramér-Rao  lower bound](https://en.wikipedia.org/wiki/Cram%C3%A9r%E2%80%93Rao_bound):

$$
\mathrm{cov}(\hat{\mathbf{\Psi}}) \geq  \left[M_F(\mathbf{\Psi},\xi)\right]^{-1}
$$

when `\(\hat{\mathbf{\Psi}}\)` is an unbiased estimator of `\(\mathbf{\Psi}\)`.

--

* Lower bounds for relative standard errors (RSEs) can be obtained from the diagonals of the inverse of the FIM

--

* This means we have a quick way of evaluating (lower bounds on) the precision of our parameter estimates.

--

.center[![](https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/apple/237/smiling-face-with-sunglasses_1f60e.png)]

???

As the name implies, optimal designs are experimental designs that are optimal with respect to some criterion.  Many such criteria exist, but most involve the [Fisher information matrix](https://en.wikipedia.org/wiki/Fisher_information) (FIM).  This matrix is useful because it gives us a [lower bound](https://en.wikipedia.org/wiki/Cram%C3%A9r%E2%80%93Rao_bound) on the covariance matrix of our parameter estimates.


---

# OK, but really. Why should I care about that thing?

.pull-left[
$$
\mathrm{cov}(\hat{\mathbf{\Psi}}) \geq  \left[M_F(\mathbf{\Psi},\xi)\right]^{-1}
$$
]

.pull-right[
* `\(D\)`-optimality criterion
{{content}}
]

--

* `\(D\)`-optimal designs maximise the determinant of the FIM
{{content}}

--

* Equivalent to minimising the volume of the confidence ellipsoid of the parameter estimates
{{content}}

--

* Huh?
{{content}}

???

The most commonly used criterion is the *D*-optimalilty criterion.  *D*-optimal designs maximize the determinant of the FIM, which is equivalent to minimizing the (lower bound of) the determinant of the covariance matrix of the parameter estimates.  For a single parameter, this means we're minimizing the width of its confidence interval, estimating it as precisely as possible.  Extending this to multiple parameters, we're minimizing the volume of the confidence ellipsoid, which loosely translates to maximizing the overall precision of parameter estimates.

---

# This is a confidence ellipsoid in 2 dimensions

.center[
&lt;img src="slides_files/figure-html/unnamed-chunk-3-1.png" width="65%" /&gt;
]

---

background-image: linear-gradient(90deg, rgba(255,255,255,1) 50%, rgba(0,0,0,0) 70%), url(https://live.staticflickr.com/7241/7404593082_9877908077_k_d.jpg)
background-size: cover
  
# Catch-22 of optimal design

.pull-left[
* For linear models, the dependence of `\(M_F(\mathbf{\Psi},\xi)\)` on `\(\mathbf{\Psi}\)` disappears
{{content}}
]

--

* No such luck for nonlinear models
{{content}}

--

* In order to design our experiment in a way that will produce the best parameter estimates, we first need to know the values of those parameters
{{content}}

--

&lt;img src="https://cdn.shopify.com/s/files/1/1061/1924/products/7_large.png?v=1571606116" width="30%" /&gt;
{{content}}

???

The FIM is typically notated by something like *M*&lt;sub&gt;*F*&lt;/sub&gt;(&amp;Phi;,&amp;Xi;), where &amp;Phi; is the vector of parameter values (e.g. *CL*, &amp;omega;&lt;sub&gt;*CL*&lt;/sub&gt;, etc.) and &amp;Xi; is the vector of design variables (e.g. dose levels, PK sampling times, etc.).  For linear models, the dependence on the parameters disappears.  Unfortunately for us, this is not the case for nonlinear models.  So in order to design our experiment in a way that will produce the best parameter estimates, we first need to know the values of those parameters.  This is the catch-22 of optimal design.  The good news is that we usually have *some* sense of parameter values from earlier clinical trials or even predictions from animal data.  We can even incorporate uncertainty of the estimates (e.g. with *ED*- or *HC*ln*D*-optimality).

Image credit: [Flickr](https://www.flickr.com/photos/msbhaven/7404593082)

---

# Nonlinear mixed effects models are even more problematic

.pull-left[
* No analytic expression for the likelihood, so we rely on approximations

* So our FIM is

    * an approximation

    * to a lower bound

    * that depends on the parameter values
]

.footnote[Mentre, Mallet, and Baccar (1997)&lt;/br&gt;
Retout, Duffull, and Mentre (2001)&lt;/br&gt;
Retout and Mentre (2003)]

.pull-right[
* But...
{{content}}
]

--

* All is not lost
{{content}}

--

* Usually we have adequate information on parameter estimates
{{content}}

--

* Approximate lower bounds are usually not far off from values obtained from simulation
{{content}}

--

* More to come on simulation...
{{content}}

???

More often than not, we're dealing with nonlinear mixed effects (NLME) models.  Since the FIM depends on the likelihood function, and there is sadly no analytic expression for the likelihood in NLME models, we must rely on approximations.  See Mentre1997-ds, Retout2001-lw, and Retout2003-jx for FIM approximations available to us.

So our FIM is

* an approximation
* to a lower bound
* that depends on the parameter values.

How useful could that even be?  Pretty useful, actually.  In most cases you'll probably find that you have adequate information on parameter estimates and that these approximate lower bounds aren't too far off what you'll get from simulations.

Either way, I **strongly** recommend that any optimal design exercise is capped off with confirmatory simulations using the tool (e.g. NONMEM) that you'll be using in the actual analysis of the data.

---

background-image: linear-gradient(90deg, rgba(255,255,255,1) 50%, rgba(0,0,0,0) 70%), url(https://live.staticflickr.com/7049/6847495120_b74032750a_k_d.jpg)
background-size: cover
  
# Evaluation vs Optimisation

.pull-left[
* Optimal design can be used to optimise a study (duh)
{{content}}
]

--

* We can also just use the FIM to quickly evaluate a design by calculating RSEs
{{content}}

--

* Optimisation is often a last resort (we can just evaluate a few candidate designs in many situations)
{{content}}

--

* Sometimes resources are too tightly constrained or our intuition isn't good enough to find feasible designs without optimising using a search algorithm
{{content}}

???

Optimal design tools can be used in the way that the name implies (to actually optimize a study), or we can simply evaluate a design with a quick calculation of the FIM (and a translation of the FIM to expected relative standard errors).  Optimization is usually a "last resort", and most of the time you'll only need to evaluate a few potential designs before settling on the answer.

That's not to say that optimization doesn't have its place.  For example, resources may be very tightly constrained, or intuitive selection of potential doses or sampling times doesn't produce sufficient results.  In these cases, we'd use a search algorithm to determine an optimal design.

Image credit: [Flickr](https://www.flickr.com/photos/hyperxp/6847495120)

---

# Sampling windows

.pull-left[
&lt;img src="slides_files/figure-html/unnamed-chunk-5-1.png" width="90%" /&gt;
]

.pull-right[
* "Optimal" sampling times are often not practical
{{content}}
]

???

* Instead of sampling at 9 hours, can specify "between 8 and 10 hours"

--

* Even without optimisation, we can't always collect samples at precise times
{{content}}

--

* Sampling windows can be optimised or determined manually
{{content}}

???

A common application of optimal design is the selection of PK sampling times.  In practice, we often can't practically collect PK samples at precise times.  Also, optimization of sampling times will usually tell you to collect samples at seemingly bizarre times like 3.4756 hours.  Or worse, it may require *multiple* samples at the same time (if you can't specify a minimum period between samples).  In these cases, we can specify windows of time for each collection.

Although methods exist for optimal determination of the windows, you will mostly likely be able to do a perfectly good job yourself by picking these manually.  You can then determine the suitability of the windows by seeing how uniform sampling within the windows impacts relative standard errors (both in optimal design tools like `PopED` or in your simulation).


---

# Tools for optimal design

![](pics/tools.png)&lt;!-- --&gt;

.footnote[Nyberg, Bazzoli, Ogungbenro, et al. (2014)]

---

# PopED

.pull-left[
![](pics/PopED_logo.png)&lt;!-- --&gt;
]

.pull-right[
* https://andrewhooker.github.io/PopED/

* Originally in O-Matrix and Matlab, now an R package
]
.footnote[Foracchia, Hooker, Vicini, et al. (2004) &lt;br&gt;
Nyberg, Ueckert, Strömberg, et al. (2012)]

---

# SSE: Stochastic Simulation and Estimation

.center[
&lt;img src="pics/sse.svg" width="65%" /&gt;
]

---

class: inverse, center, middle

# Example: Closed-form PK model

---

# Introducing our example

.pull-left[
**Mockdrozaline** has been studied in adult subjects, and we now must design a study in pediatric patients.

A study objective is to evaluate the PK in this new population, but PK sampling is necessarily sparse.

Our mission is to ensure that these samples are timed such that we can sufficiently estimate the PK parameters in pediatric patients.
]

--

.pull-right[

* Population

  - 12 subjects
  - Aged 6 to &lt; 12
  - Expected median weight of 32 kg

* Treatment

  - 10 mg QD mockdrozaline for 24 weeks

* PK samples

  - Proposed samples:
  
      + 5 hours postdose on Day 1;
      + predose on Weeks 8, 12, 24; and
      + 168 hours after the final dose


]
???

Mockdrozaline has been studied in adult subjects, and we now must design a study in pediatric patients.  The primary objective is to evaluate the PK in this new population, but PK sampling is necessarily sparse.  Our mission is to ensure that these samples are timed such that we can sufficiently estimate the PK parameters in pediatric patients.

---

# The model

.pull-left[
1-compartment model with 1st-order absorption and weight covariates on CL and V:
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; CL &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; V &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; KA &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; wt_cl &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; wt_v &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 100 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.25 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.75 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

Log-normal IIV on `CL`, `V`, and `KA`; additive &amp; proportional residual error:
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; om_CL &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; om_V &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; om_KA &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; sigma_prop &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; sigma_add &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.08 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.05 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
(these are variances)
]

--

.pull-right[
&lt;img src="slides_files/figure-html/unnamed-chunk-11-1.png" width="90%" /&gt;
]

???

A wealth of data in adults has allowed us to describe orally-administered mockdrozaline PK using a 1-compartment model with first-order absorption, and 2 covariates: weight on clearance (`wt_cl`) and weight on volume (`wt_v`).

We include log-normal IIV on `CL`, `V`, and `KA`, and a combined additive and proportional residual error.

Note that we reach steady state very quickly (the half-life is around 7 hours), so we can assume that all samples after Day 1 (i.e. from Week 4 onward) are at steady state.

---

class: poll-slide

# Poll Question #2

## Which of these designs will give us the best&lt;sup&gt;*&lt;/sup&gt; RSE for KA, assuming a single 10 mg dose in 10 adult (70 kg) subjects?



.pull-left[
&lt;img src="slides_files/figure-html/unnamed-chunk-13-1.png" width="90%" /&gt;
]

.footnote[[*]According to `PopED` &lt;/br&gt;
`\(t_\textrm{max} \approx\)` 6 hours]

.pull-right[
1. 1, 24, 48, 96 hours
{{content}}
]

--

2. 4, 24, 48, 96 hours
{{content}}

--

3. 6, 24, 48, 96 hours
{{content}}

--

4. 12, 24, 48, 96 hours
{{content}}

--

5. My kid came looking for snacks and I missed everything you just said.
{{content}}

---

class: poll-slide

# Poll Question #2

## Which of these designs will give us the best&lt;sup&gt;*&lt;/sup&gt; RSE for KA, assuming a single 10 mg dose in 10 adult (70 kg) subjects?

* Design 1 (first sample at 1 hours): RSE = 23.4%

* Design 2 (first sample at 4 hours): RSE = 27.1%

* Design 3 (first sample at 6 hours): RSE = 30.5%

* Design 4 (first sample at 12 hours): RSE = 48.9%

.footnote[[*]According to `PopED`]
---

background-image: linear-gradient(90deg, rgba(255,255,255,1) 50%, rgba(0,0,0,0) 70%), url(https://live.staticflickr.com/6136/6039404494_a6cccf1f4a_k_d.jpg)
background-size: cover
  
# The `PopED` setup

.pull-left[
`PopED` requires 3 functions in order to define a model:

* `ff()`, the structural model;

* `fg()`, the parameter model (including IIV and IOV);

* `feps()`, the residual error model.

`create.poped.database()` collects together these model functions, parameter values, and everything related to study design.
]



???

(The names of the functions can be different, but these are the naming conventions used by `PopED`.)  There are built-in `ff()` and `feps()` functions for basic structural models with additive and/or proportional residual error, but you'll need to at least write your own `fg()` function (don't worry, there are examples to get you started).

Image credit: [Flickr](https://www.flickr.com/photos/dmuth/6039404494)

---

# Plot of initial design

.pull-left[

```r
plot_model_prediction(
  poped_db,
  model.names = c("Day 1", "Steady state"),
  facet_scales = "free_x",
  model_num_points = 200
) +
  labs(x = "Time from dose (h)") +
  theme_bw()
```
]

.pull-right[
![](slides_files/figure-html/test-plot-1-1.png)
]

???

`PopED` includes a function to generate a quick test plot showing the typical response(s), along with the initial sampling times.

---

# Evaluate FIM


```r
FIM &lt;- evaluate.fim(poped_db) 
det(FIM)
```

```
. [1] 0.04804071
```


```r
get_rse(FIM, poped_db)
```

```
.      bpop[1]      bpop[2]      bpop[3]       D[1,1]       D[2,2]       D[3,3] 
. 2.983306e+05 3.132072e+06 4.936333e+06 5.192188e+01 4.888612e+02 6.485818e+02 
.   SIGMA[1,1]   SIGMA[2,2] 
. 2.997297e+01 4.082483e+01
```


```r
poped_db2 &lt;- create.poped.database( poped_db, xt = c(5, c(23, 24, 24, 168)) )
FIM2 &lt;- evaluate.fim(poped_db2) 
get_rse(FIM2, poped_db2)
```

```
.    bpop[1]    bpop[2]    bpop[3]     D[1,1]     D[2,2]     D[3,3] SIGMA[1,1] 
.   15.48778  142.08530  223.35925   50.88485  418.53695  549.75962   29.68444 
. SIGMA[2,2] 
.   40.82396
```

???

This determinant is what will be used to optimize the design, but it's not particularly helpful by itself.  What we really need are the predicted standard errors based on the FIM.

The RSEs are crazy high, which suggests that the model is not identifiable.  A slight tweak to a single timepoint (increasing the number of support points) may help.

The RSEs are no longer in the millions, but certainly not as low as we'd hope for. Let's see if we can make any improvements with optimization.

---

# *D*-optimal design: Starting from the original design

.pull-left-40[

```r
poped_db &lt;- create.poped.database(
  ...
  xt = c(5, c(rep(24, 3), 168)),
  minxt = c(0, c(rep(23, 3), 96)),
  maxxt = c(6, c(rep(24, 3), 168)),
  ...
)
output &lt;- poped_optim(
  poped_db,
  opt_xt = TRUE,
  parallel = TRUE,
  parallel_type = "multicore",
  seed = 1
)
summary(output)
```
]

.pull-right-60[
.font-90[

```
. ===============================================================================
. FINAL RESULTS
. Optimized Sampling Schedule
. Group 1: Model 1: 0.3276
. Group 1: Model 2:     23     24     24     96
. 
. OFV = 20.2291
. 
. Efficiency: 
.   ((exp(ofv_final) / exp(ofv_init))^(1/n_parameters)) = 18.322
. 
. Expected relative standard error
. (%RSE, rounded to nearest integer):
.     Parameter   Values     RSE_0   RSE
.       bpop[1]       10    298333    38
.       bpop[2]      100   3132099   149
.       bpop[3]     0.25   4936376   153
.        D[1,1]     0.08        52    50
.        D[2,2]      0.1       489   204
.        D[3,3]      0.2       649   127
.    SIGMA[1,1]     0.05        30    30
.    SIGMA[2,2]        1        41    41
. 
. Total running time: 9.327 seconds
```
]
]


???

Better, but still not good enough.

---

# Add another post dose sample at SS




```r
poped_db_extra_ss &lt;- create.poped.database(
  ...
  xt = c(5, c(rep(24, 3), 4, 168)),
  minxt = c(0, c(rep(23, 3), 0, 96)),
  maxxt = c(6, c(rep(24, 3), 6, 168)),
  ...
)
```


```r
FIM_extra_ss &lt;- evaluate.fim(poped_db_extra_ss) 
get_rse(FIM_extra_ss, poped_db_extra_ss)
```

```
.    bpop[1]    bpop[2]    bpop[3]     D[1,1]     D[2,2]     D[3,3] SIGMA[1,1] 
.   13.38487   80.99149  119.36373   46.82132  253.41994  288.82097   24.18497 
. SIGMA[2,2] 
.   40.80823
```

???

Add another post dose sample at steady state.

We'll create the PopED database from scratch again.  This is probably easier than updating an old database when you change the number of samples because certain vectors (like `grouped_xt`) are generated automatically if you don't supply the argument and we don't want to fuss with that.

---

# *D*-optimal design: Add another post dose sample at SS

.pull-left-40[

```r
output_extra_ss &lt;- poped_optim(
  poped_db_extra_ss,
  opt_xt = TRUE,
  parallel = TRUE,
  parallel_type = "multicore",
  seed = 1
)
summary(output_extra_ss)
```
]

.pull-right-60[
.font-90[

```
. ===============================================================================
. FINAL RESULTS
. Optimized Sampling Schedule
. Group 1: Model 1:      6
. Group 1: Model 2: 0.9979     23     23     24     96
. 
. OFV = 24.6494
. 
. Efficiency: 
.   ((exp(ofv_final) / exp(ofv_init))^(1/n_parameters)) = 1.6623
. 
. Expected relative standard error
. (%RSE, rounded to nearest integer):
.     Parameter   Values   RSE_0   RSE
.       bpop[1]       10      13     9
.       bpop[2]      100      81    26
.       bpop[3]     0.25     119    35
.        D[1,1]     0.08      47    47
.        D[2,2]      0.1     253   124
.        D[3,3]      0.2     289   120
.    SIGMA[1,1]     0.05      24    25
.    SIGMA[2,2]        1      41    41
. 
. Total running time: 12.69 seconds
```
]]

---

# Add sample after the final (SS) dose


```r
poped_db_final &lt;- create.poped.database(
  poped_db_extra_ss,
  xt = c(5, c(rep(24, 3), 72, 168)),
  minxt = c(0, c(rep(23, 3), 0, 168)),
  maxxt = c(6, c(rep(24, 3), 168, 168))
)
```


```r
FIM_final &lt;- evaluate.fim(poped_db_final) 
get_rse(FIM_final, poped_db_final)
```

```
.    bpop[1]    bpop[2]    bpop[3]     D[1,1]     D[2,2]     D[3,3] SIGMA[1,1] 
.   12.31062   86.75053  136.64068   50.42738  317.03881  419.93344   29.55819 
. SIGMA[2,2] 
.   28.95827
```

???

Add another sample after the final dose.

This time we can just update the previous PopED database.

---

# *D*-optimal design: Add sample after the final (SS) dose

.pull-left-40[

```r
output_final &lt;- poped_optim(
  poped_db_final,
  opt_xt = TRUE,
  parallel = TRUE,
  parallel_type = "multicore",
  seed = 1
)
summary(output_final)
```
]

.pull-right-60[
.font-90[

```
. ===============================================================================
. FINAL RESULTS
. Optimized Sampling Schedule
. Group 1: Model 1: 0.4454
. Group 1: Model 2:     23     23     23  41.09    168
. 
. OFV = 27.717
. 
. Efficiency: 
.   ((exp(ofv_final) / exp(ofv_init))^(1/n_parameters)) = 2.7831
. 
. Expected relative standard error
. (%RSE, rounded to nearest integer):
.     Parameter   Values   RSE_0   RSE
.       bpop[1]       10      12     9
.       bpop[2]      100      87    14
.       bpop[3]     0.25     137    17
.        D[1,1]     0.08      50    48
.        D[2,2]      0.1     317    74
.        D[3,3]      0.2     420    63
.    SIGMA[1,1]     0.05      30    29
.    SIGMA[2,2]        1      29    39
. 
. Total running time: 11.964 seconds
```
]]

---

# Near-optimal design


```r
poped_db_practical &lt;- create.poped.database(
  poped_db_final,
  xt = c(0.5, rep(24, 3), 32, 168)
)
FIM_practical &lt;- evaluate.fim(poped_db_practical) 
get_rse(FIM_practical, poped_db_practical)
```

```
.    bpop[1]    bpop[2]    bpop[3]     D[1,1]     D[2,2]     D[3,3] SIGMA[1,1] 
.   10.15307   19.61044   22.79548   48.67831   97.63716   74.56113   26.52843 
. SIGMA[2,2] 
.   40.69749
```

???

This optimal design serves us well, but it's not very practical to request a sample at 41.09 hours after the final dose.  For a dose at 8 AM, that would mean a sample at around 1 AM.  Instead we'll construct a similar design with more practical times and see how that affects our RSEs.  We can do this by building a new `PopED` database based on the previous one.

This second-to-last sample at 32 hours would be at 4 PM the day after an 8 AM final dose.  More practical, and we don't seem to lose too much in terms of RSE.

---

.pull-left[

```r
plot_model_prediction(
  poped_db_practical,
  model.names = c("Day 1", "Steady state"),
  facet_scales = "free_x",
  model_num_points = 200
) +
  labs(x = "Time from dose (h)") +
  theme_bw()
```
]

.pull-right[
![](slides_files/figure-html/test-plot-2-1.png)
]

---

# Sampling windows

.pull-left[

```r
plot_efficiency_of_windows(
  poped_db_practical,
  xt_plus  = c(0.25, rep(0, 3), 2, 0),
  xt_minus = c(0.25, rep(1, 3), 2, 4)
)
```
]

.pull-right[
![](slides_files/figure-html/test-plot-3-1.png)
]

???

Next, we'll construct windows around our sampling times to provide some flexibility in sampling.  We evaluate the effect of this flexibility on the RSEs.

We'll allow:

* up to 15 minutes before or after the first sample at half an hour (i.e., 15-45 minutes post dose)
* up to 1 hour before each trough sample (i.e., 0-1 hours pre dose)
* up to 2 hours before or after the 32-hour sample after the final dose (i.e., 30-34 hours after the final dose)
* up to 4 hours before the final sample (i.e., 164-168 hours post final dose)

The 100 sets of simulated samples show no significant deviations from the RSEs for the optimal samples.

---

# SSE Results

.pull-left[
&lt;img src="slides_files/figure-html/unnamed-chunk-31-1.png" width="100%" /&gt;
]

.pull-right[
.font-90[
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; param &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; poped_pct_rse &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; sim_pct_rse &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; sim_pct_bias &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; THETA1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10.2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 12.2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4.2 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; THETA2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19.6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 29.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 6.7 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; THETA3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 22.8 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 32.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.4 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; OMEGA(1,1) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 48.7 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 74.2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 41.7 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; OMEGA(2,2) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 97.6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 132.8 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 25.9 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; OMEGA(3,3) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 74.6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 90.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 7.2 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; SIGMA(1,1) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 26.5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 28.6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -6.7 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; SIGMA(2,2) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 40.7 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 41.3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11.9 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]]

---

class: inverse, center, middle

# Example: ODE PK model

---

# Study design and model

.pull-left[
**Fakinumab** is being studied in humans for the first time.

* Single IV bolus doses of fakinumab: 0.03, 0.1, 0.3, 1, 3, and 10 mg.
* 6 subjects per dose group will be on active drug.
* Proposed samples: 1 and 4 hours post dose, and 1, 3, 7, 14, 21 days post dose.
]

.pull-right[
Based on projections from animal PK data, we predict that a 2-compartment model with linear and nonlinear (Michaelis-Menten) clearance from the central compartment will desribe the data.

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; CL &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; VMAX &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; KM &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; V1 &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Q &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; V2 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 20 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2.5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

We include log-normal IIV on `CL`, `VMAX`, and `V1`, and a proportional residual error.

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; om_CL &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; om_VMAX &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; om_V1 &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; sigma_prop &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 0.2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.15 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]

---

# Model in `mrgsolve`


```
. 
. Model file:  model_poped.cpp 
. [ param ]
. CL = 1, VMAX = 10, KM = 10, V1 = 8, Q = 10, V2 = 100
. 
. [ cmt ] CENT PERIPH
. 
. [ main ]
. double ke  = CL/V1;
. double k12 = Q/V1;
. double k21 = Q/V2;
. 
. [ ode ]
. double CP = CENT/V1;
. 
. dxdt_CENT = k21*PERIPH - k12*CENT - VMAX*CP/(KM + CP) - ke*CENT;
. dxdt_PERIPH = k12*CENT - k21*PERIPH;
. 
. [ capture ]
. CP
```

---

# `ff()` for `mrgsolve` model

.pull-left[
.font-80[

```r
ff &lt;- function(model_switch, xt, parameters, poped.db) {
  obs_time &lt;- as.numeric(xt)
  dose_time &lt;- 0
  
  dose &lt;- data.frame(
    ID = 1, 
    amt = parameters[["DOSE"]]*1000,
    cmt = 1, 
    evid = 1,
    time = dose_time
  )
  obs &lt;- data.frame(
    ID = 1, 
    amt = 0, 
    cmt = 1, 
    evid = 0, 
    time = sort(obs_time)
  )
```
]]

.pull-right[
.font-80[

```r
  data &lt;- arrange(bind_rows(dose,obs),time)

  mod &lt;- param(mod, parameters)
  
  out &lt;- mrgsim_q(mod,data,output="matrix")
  
  out &lt;- out[data$evid==0,"CP",drop=FALSE][match(obs_time,obs$time),]
  
  return(list(y = out, poped.db = poped.db))
}
```
]]

---

# Plot of initial design



.center[
&lt;img src="slides_files/figure-html/unnamed-chunk-39-1.png" width="80%" /&gt;
]

---

# Evaluate FIM


```r
FIM_mrg &lt;- evaluate.fim(poped_db_mrg) 
get_rse(FIM_mrg, poped_db_mrg)
```

```
.    bpop[1]    bpop[2]    bpop[3]    bpop[4]    bpop[5]    bpop[6]     D[1,1] 
.  10.874541  10.660202   7.935122   6.355306   8.894763   3.620234  38.990317 
.     D[2,2]     D[3,3] SIGMA[1,1] 
.  32.096512  31.668012  10.775738
```

---

# Sampling windows

.pull-left[

```r
plot_efficiency_of_windows(
  poped_db_mrg,
  xt_plus  = c(rep(1/24, 2), rep(3/24, 5)),
  xt_minus = c(rep(1/24, 2), rep(3/24, 5))
)
```
]

.pull-right[
&lt;img src="slides_files/figure-html/unnamed-chunk-42-1.png" width="100%" /&gt;
]

???

We'll allow:

* 1 hour before or after samples on Day 1
* 3 hours before or after other sampling times

Again, the 100 sets of simulated samples show no significant deviations from the RSEs for the original samples, so we're golden.


---

# SSE results

.pull-left[
&lt;img src="slides_files/figure-html/unnamed-chunk-43-1.png" width="100%" /&gt;
]

.pull-right[
.font-90[
&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; param &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; poped_pct_rse &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; sim_pct_rse &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; sim_pct_bias &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; THETA1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10.9 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 13.9 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 13.6 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; THETA2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10.7 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 17.1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1.8 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; THETA3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 7.9 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 38.4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 15.5 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; THETA4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 6.4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10.4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 6.6 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; THETA5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 8.9 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 16.9 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -5.8 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; THETA6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 3.6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 9.6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -4.4 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; OMEGA(1,1) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 39.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 38.9 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -11.9 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; OMEGA(2,2) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 32.1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 51.1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 24.6 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; OMEGA(4,4) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 31.7 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 52.3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -12.6 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; SIGMA(1,1) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 10.8 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 12.3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; -7.0 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]]

---

class: inverse, center, middle

# Example: ODE PK/PD model

---

# Study design &amp; model

.pull-left[

* QD SC doses of **filgrastim**: 1, 3, and 10 &amp;mu;g/kg.

* 10 subjects per dose group will be on active drug.

* Dense PK and ANC samples on days 1 and 7.
]

.pull-right[

![](pics/gcsf_paper.png)&lt;!-- --&gt;

* PK/PD model from DDMORE .font-80[http://repository.ddmore.eu/model/DDMODEL00000077.6]

* NONMEM model translated to `mrgsolve`
.font-80[https://github.com/mrgsolve/depot/blob/master/vignette/gcsf.md]
]

.footnote[Krzyzanski, Wiczling, Lowe, et al. (2010)]

---

# Filgrastim ANC model

.center[
&lt;img src="pics/gcsf_model.png" width="85%" /&gt;
]

.footnote[Krzyzanski, Wiczling, Lowe, et al. (2010)]

---

# PK and ANC simulations

.center[
&lt;img src="slides_files/figure-html/unnamed-chunk-47-1.png" width="80%" /&gt;
]

---

# Evaluate FIM for initial design




```r
FIM_gcsf &lt;- evaluate.fim(poped_db_gcsf)
get_rse(FIM_gcsf, poped_db_gcsf)
```


```
.    bpop[2]    bpop[5]    bpop[6]    bpop[7]    bpop[8]    bpop[9]   bpop[11] 
.   3.289140  13.518742  12.604107   8.265412   3.822461  19.528269   4.066511 
.   bpop[13]   bpop[14]   bpop[15]   bpop[16]   bpop[17]     D[1,1]     D[2,2] 
.  17.017908  10.771361  20.851250   8.289988   7.664966  26.961113  32.644613 
.     D[3,3]     D[5,5]     D[6,6]     D[7,7] SIGMA[1,1] SIGMA[3,3] SIGMA[4,4] 
.  31.369081  41.941250  29.156946  26.406506   3.900224   6.541108   7.713365
```

---

class: poll-slide

# Poll Question #3

## Any better doses for estimating SC50 or Smax?



.pull-left[
&lt;img src="slides_files/figure-html/unnamed-chunk-52-1.png" width="100%" /&gt;
]

.pull-right[
1. 1, 3, 10 &amp;mu;g/kg
{{content}}
]

--

2. 0.3, 1, 3 &amp;mu;g/kg
{{content}}

--

3. 0.3, 1, 10 &amp;mu;g/kg
{{content}}

--

4. 0.1, 1, 3 &amp;mu;g/kg
{{content}}

--

5. Are you still talking? I think you're on mute.
{{content}}


---

class: poll-slide

# Poll Question #3

## Any better doses for estimating `\(SC_{50}\)` or `\(S_\textrm{max}\)`?

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;color: black !important;background-color: white !important;"&gt; Parameter &lt;/th&gt;
   &lt;th style="text-align:left;color: black !important;background-color: white !important;"&gt; Design 1 &lt;/th&gt;
   &lt;th style="text-align:left;color: black !important;background-color: white !important;"&gt; Design 2 &lt;/th&gt;
   &lt;th style="text-align:left;color: black !important;background-color: white !important;"&gt; Design 3 &lt;/th&gt;
   &lt;th style="text-align:left;color: black !important;background-color: white !important;"&gt; Design 4 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; bpop[15] &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 20.9 &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 24.8 &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 21.8 &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 26.4 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; bpop[16] &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 8.3 &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 13.6 &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 9.5 &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 13.9 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; bpop[17] &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 7.7 &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 13.1 &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 8.7 &lt;/td&gt;
   &lt;td style="text-align:left;color: black !important;background-color: white !important;"&gt; 13.4 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

class: inverse, center, middle

# Wrap up

---

background-image: linear-gradient(90deg, rgba(255,255,255,1) 50%, rgba(0,0,0,0) 70%), url(https://live.staticflickr.com/1293/645438825_1039d343a0_k_d.jpg)
background-size: cover

# What did we learn today?

.pull-left[
* Optimal design can be a useful, if imperfect, tool to explore and optimize study design options
{{content}}
]

--

* Always run confirmatory simulations
{{content}}

--

* Optimal design: it's not just for PK sampling any more!
{{content}}

???

Image credit: [Flickr](https://www.flickr.com/photos/flex/645438825/)

---

background-image: linear-gradient(90deg, rgba(255,255,255,1) 50%, rgba(0,0,0,0) 70%), url(https://live.staticflickr.com/5614/15348032367_c571131bb9_k_d.jpg)
background-size: cover
  
# What did we miss?

.pull-left[
* Dealing with parameter uncertainty (e.g., `\(ED\)`-, `\(HC\textrm{ln}D\)`-optimality)
{{content}}
]

--

* Dealing with model uncertainty (e.g. `\(T\)`-optimality)
{{content}}

--

* Ignoring unimportant parameters (e.g. `\(D_S\)`-, `\(G\)`-optimality)
{{content}}

--

* Basically an alphabet of other criteria: `\(A\)`-, `\(C\)`-, `\(G\)`-, `\(V\)`-optimality, etc.
{{content}}

--

* Almost all of `PopED`'s options
{{content}}

???

Image credit: [Flickr](https://www.flickr.com/photos/traveloriented/15348032367/)

---

background-image: linear-gradient(90deg, rgba(255,255,255,1) 50%, rgba(0,0,0,0) 70%), url(https://live.staticflickr.com/6077/6039404304_db836ce6d8_k_d.jpg)
background-size: cover
  
# Software resources

.pull-left[
* `PopED`: https://andrewhooker.github.io/PopED/

* `mrgsolve`: https://mrgsolve.github.io/

* `babylon`: https://github.com/metrumresearchgroup/babylon
  + `rbabylon`: https://metrumresearchgroup.github.io/rbabylon/
]

???

Image credit: [Flickr](https://www.flickr.com/photos/dmuth/6039404304)

---

# References

Foracchia, M, A. Hooker, P. Vicini, et al. (2004). "POPED, a software
for optimal experiment design in population kinetics". In: _Comput.
Methods Programs Biomed._ 74.1, pp. 29-46.

Krzyzanski, W, P. Wiczling, P. Lowe, et al. (2010). "Population
modeling of filgrastim PK-PD in healthy adults following intravenous
and subcutaneous administrations". In: _J. Clin. Pharmacol._ 50.9
Suppl, pp. 101S-112S.

Mentre, F, A. Mallet, and D. Baccar (1997). "Optimal design in
random-effects regression models". In: _Biometrika_ 84.2, pp.
429-442.

Nyberg, J, C. Bazzoli, K. Ogungbenro, et al. (2014). "Methods and
software tools for design evaluation for population
pharmacokinetics-pharmacodynamics studies". In: _Br. J. Clin.
Pharmacol._.

Nyberg, J, S. Ueckert, E. A. Strömberg, et al. (2012). "PopED: an
extended, parallelized, nonlinear mixed effects models optimal design
tool". In: _Comput. Methods Programs Biomed._ 108.2, pp. 789-805.

Retout, S, S. Duffull, and F. Mentre (2001). "Development and
implementation of the population Fisher information matrix for the
evaluation of population pharmacokinetic designs". In: _Comput.
Methods Programs Biomed._ 65.2, pp. 141-151.

Retout, S. and F. Mentre (2003). "Further developments of the Fisher
information matrix in nonlinear mixed effects models with evaluation
in population pharmacokinetics". In: _J. Biopharm. Stat._ 13.2, pp.
209-227.

---

class: center, middle

# Thank you

---

class: inverse, center, middle

# Backup slides

---

class: inverse, center, middle

# Simulation

---

# SSE: `template.csv`

```
$PROB RUN# run_num
$INPUT ID TIME EVID MDV CMT AMT SS II DV WT
$DATA data_fname IGNORE=@
...
$SIMULATION (run_num)
$ESTIMATION METHOD=1 INTER PRINT=1 MSFO=./run_num.msf
```

---

# SSE: Run the models with `rbabylon`


```r
run_model &lt;- function(.design_dir, .run_num) {
  # Modify and write the control stream
  ctl_template %&gt;% 
    str_replace("run_num", as.character(.run_num)) %&gt;% 
    str_replace("data_fname", paste0("../", .run_num, ".csv")) %&gt;% 
    writeLines(file.path(.design_dir, paste0(.run_num, ".ctl")))
  
  # Run the model
* new_model(
*   .yaml_path = paste0(.run_num, ".yaml"),
*   .description = .run_num,
*   .directory = design_dir
* ) %&gt;%
*   submit_model()
}
```

---

# SSE: Collect the results with `rbabylon`


```r
get_est &lt;- function(.design_dir) {
  est &lt;- map_dfr(seq_len(n_rep), function(.run_num) {
*   mod &lt;- read_model(paste0(.run_num, ".yaml"), .directory = .design_dir)
*   mod_sum &lt;- try(model_summary(mod), silent = TRUE)
    if (inherits(mod_sum, "try-error")) return(NULL)
*   mod_sum %&gt;%
*     param_estimates() %&gt;%
      filter(fixed == 0) %&gt;% 
      select(param = names, estimate) %&gt;% 
      mutate(rep = .run_num)
  }) %&gt;% 
    left_join(true_vals) %&gt;% 
    mutate(
      param = factor(param, levels = unique(.[["param"]])),
      pct_bias = (estimate - value) / abs(value) * 100
    ) %&gt;% 
    filter(abs(pct_bias) &lt; 5000)
  return(est)
}
```

---

class: inverse, center, middle

# PopED setup

---

# `ff()`: the structural model

.pull-left-60[

```r
ff &lt;- function(model_switch, xt, parameters, poped.db){
  with(as.list(parameters),{
    
    CL &lt;- CL*(WT/70)^(WT_CL)
    V &lt;- V*(WT/70)^(WT_V)
    
    y_sd &lt;- (DOSE * KA/(V * (KA - CL/V))) *
      (exp(-CL/V * xt) - exp(-KA * xt))
    
    y_ss &lt;- (DOSE * KA/(V * (KA - CL/V))) *
      (exp(-CL/V * xt) / (1 - exp(-CL/V * TAU)) -
         exp(-KA * xt) / (1 - exp(-KA * TAU)))
    
    y &lt;- xt
    y[model_switch == 1] &lt;- y_sd[model_switch == 1]
    y[model_switch == 2] &lt;- y_ss[model_switch == 2]
      
    return(list(y = y, poped.db = poped.db))
  })
}
```
]

.pull-right-40[
`PopED` expects a function with the following arguments:

* `model_switch`: A vector of values identifying which model response should be computed for the corresponding `xt` value

* `xt`: A vector of independent variable values (often time).

* `parameters`: A named list of parameter values.

* `poped.db`: A `PopED` database.
]

???

`PopED` expects a function with the following arguments:

* `model_switch`: A vector of values, the same size as `xt`, identifying which model response should be computed for the corresponding `xt` value (e.g., for models with PK and PD responses).

* `xt`: A vector of independent variable values (often time).

* `parameters`: A named list of parameter values.

* `poped.db`: A `PopED` database. This can be used to extract information that may be needed in the model file.

We define a model with single dose and steady-state components, making use of the `model_switch` argument to determine which expression to use at each timepoint.

---

# `fg()`: the parameter model

.pull-left[

```r
fg &lt;- function(x, a, bpop, b, bocc){
  parameters = c(
    CL    = bpop[1] * exp(b[1]),
    V     = bpop[2] * exp(b[2]),
    KA    = bpop[3] * exp(b[3]),
    WT_CL = bpop[4],
    WT_V  = bpop[5],
    DOSE  = a[1] * 1000,
    TAU   = a[2],
    WT    = a[3]
  )
  return(parameters) 
}
```
]

.pull-right[
* `x`: A vector of discrete design variables (not used here).

* `a`: A vector of covariates.

* `bpop`: A vector of fixed effect parameters (i.e., `THETA`s).

* `b`: A vector of individual IIV random effects (i.e., `ETA`s).

* `bocc`: A vector of individual IOV random effects (i.e., `ETA`s) (not used here).

In this example, we include IIV on `CL`, `V`, and `KA`, and pass through dose, tau, and body weight as covariates.
]

???

Next is the parameter model, where we add IIV and/or IOV.  Again, there are several arguments that `PopED` expects:

* `x`: A vector of discrete design variables (not used here).
* `a`: A vector of covariates. Note that dose and dosing interval are also passed in as covariates, in addition to what we'd normally classify as covariates in a PK/PD model.
* `bpop`: A vector of fixed effect parameters (i.e., `THETA`s).
* `b`: A vector of individual IIV random effects (i.e., `ETA`s).
* `bocc`: A vector of individual IOV random effects (i.e., `ETA`s) (not used here).

In this example, we include IIV on `CL`, `V`, and `KA`, and pass through dose, tau, and body weight as covariates.

---

# `feps()`: the residual error model

.pull-left-60[

```r
feps &lt;- function(model_switch, xt, parameters, epsi, poped.db){
  returnArgs &lt;- do.call(
    poped.db$model$ff_pointer,
    list(model_switch, xt, parameters, poped.db)
  ) 
  y &lt;- returnArgs[[1]]
  poped.db &lt;- returnArgs[[2]]
  y = y * exp(epsi[, 1])
  return(list(y = y, poped.db = poped.db)) 
}
```
]

.pull-right-40[
* `epsi`: A matrix of residual random effects (i.e. `EPS`s or `ERR`s).
]

???

Finally, we define the residual error model structure.  We're using one of the built-in functions, but suppose instead we wanted a log-normal residual error model (i.e., additive on the log scale). We would need to define a custom function for this as well.  The setup is a bit esoteric, so we would just start with one of the built-in functions and tweak as necessary.  There's only one new argument here:

* `epsi`: A matrix of residual random effects (i.e. `EPS`s or `ERR`s).

---

# `create.poped.database()`


```r
poped_db &lt;- create.poped.database(
  ff_fun = ff,
  fg_fun = fg,
  fError_fun = feps.add.prop,
  bpop = c(CL = 10, V = 100, KA = 0.25, WT_CL = 0.75, WT_V = 1), 
  notfixed_bpop = c(1, 1, 1, 0, 0),
  d = c(CL = 0.08, V = 0.1, KA = 0.2), 
  sigma = c(0.05, 1),
  m = 1,
  groupsize = 12,
  xt = c(5, c(rep(24, 3), 168)),
  minxt = c(0, c(rep(23, 3), 96)),
  maxxt = c(6, c(rep(24, 3), 168)),
  model_switch = c(1, rep(2, 4)),
  a = cbind(DOSE = 10, TAU = 24, WT = 32)
)
```

???

Now that we have our model defined, we bring it all together with details of the design.  There's a lot going on here even for this simple example (the documentation is 13 pages long for this function alone), so we'll break this down into pieces.

We've covered the functions used in the first 3 arguments.  Let's break down the rest.

---

# `create.poped.database()`

.pull-left-60[

```r
poped_db &lt;- create.poped.database(
* ff_fun = ff,
* fg_fun = fg,
* fError_fun = feps.add.prop,
  bpop = c(CL = 10, V = 100, KA = 0.25, WT_CL = 0.75, WT_V = 1), 
  notfixed_bpop = c(1, 1, 1, 0, 0),
  d = c(CL = 0.08, V = 0.1, KA = 0.2), 
  sigma = c(0.05, 1),
  m = 1,
  groupsize = 12,
  xt = c(5, c(rep(24, 3), 168)),
  minxt = c(0, c(rep(23, 3), 96)),
  maxxt = c(6, c(rep(24, 3), 168)),
  model_switch = c(1, rep(2, 4)),
  a = cbind(DOSE = 10, TAU = 24, WT = 32)
)
```
]

.pull-right-40[
* `ff_fun`, `fg_fun`, `fError_fun`: Model functions
]

---

# `create.poped.database()`

.pull-left-60[

```r
poped_db &lt;- create.poped.database(
  ff_fun = ff,
  fg_fun = fg,
  fError_fun = feps.add.prop,
* bpop = c(CL = 10, V = 100, KA = 0.25, WT_CL = 0.75, WT_V = 1),
* notfixed_bpop = c(1, 1, 1, 0, 0),
* d = c(CL = 0.08, V = 0.1, KA = 0.2),
* sigma = c(0.05, 1),
  m = 1,
  groupsize = 12,
  xt = c(5, c(rep(24, 3), 168)),
  minxt = c(0, c(rep(23, 3), 96)),
  maxxt = c(6, c(rep(24, 3), 168)),
  model_switch = c(1, rep(2, 4)),
  a = cbind(DOSE = 10, TAU = 24, WT = 32)
)
```
]

.pull-right-40[
* `bpop`: our current best estimates of the fixed effect parameters (`THETA`s)

* `notfixed_bpop`: whether or not they're being estimated

* `d`: diagonal elements of the IIV covariance matrix (`OMEGA`)

* `sigma`: diagonal elements of the residual covariance matrix (`SIGMA`)
]

???

For this example, we're assuming that our weight covariate parameters are fixed in the model.  We need to tell `PopED` they're not not fixed (yes, that's a double negative).  Each element of this vector corresponds to an element of `bpop`.  We use `1` to denote "not fixed" (estimated) and `0` to denote "not not fixed" (not estimated).

These are the diagonal elements of the IIV covariance matrix (`OMEGA`).  `covd` could be used for off-diagonal elements, but we're assuming those are all zero here.

Diagonal elements of the residual covariance matrix.

---

# `create.poped.database()`

.pull-left-60[

```r
poped_db &lt;- create.poped.database(
  ff_fun = ff,
  fg_fun = fg,
  fError_fun = feps.add.prop,
  bpop = c(CL = 10, V = 100, KA = 0.25, WT_CL = 0.75, WT_V = 1),
  notfixed_bpop = c(1, 1, 1, 0, 0),
  d = c(CL = 0.08, V = 0.1, KA = 0.2),
  sigma = c(0.05, 1),
* m = 1,
* groupsize = 12,
  xt = c(5, c(rep(24, 3), 168)),
  minxt = c(0, c(rep(23, 3), 96)),
  maxxt = c(6, c(rep(24, 3), 168)),
  model_switch = c(1, rep(2, 4)),
  a = cbind(DOSE = 10, TAU = 24, WT = 32)
)
```
]

.pull-right-40[
* `m`: number of groups

* `groupsize`:  number of subjects in each group
]

???

`m` is the number of groups, with `groupsize` subjects in each group.  We could use multiple groups to define multiple arms of a study, or to assign different designs to different subjects.

---

# `create.poped.database()`

.pull-left-60[

```r
poped_db &lt;- create.poped.database(
  ff_fun = ff,
  fg_fun = fg,
  fError_fun = feps.add.prop,
  bpop = c(CL = 10, V = 100, KA = 0.25, WT_CL = 0.75, WT_V = 1),
  notfixed_bpop = c(1, 1, 1, 0, 0),
  d = c(CL = 0.08, V = 0.1, KA = 0.2),
  sigma = c(0.05, 1),
  m = 1,
  groupsize = 12,
* xt = c(5, c(rep(24, 3), 168)),
* minxt = c(0, c(rep(23, 3), 96)),
* maxxt = c(6, c(rep(24, 3), 168)),
* model_switch = c(1, rep(2, 4)),
  a = cbind(DOSE = 10, TAU = 24, WT = 32)
)
```
]

.pull-right-40[
* `xt`: initial sampling design

* `minxt`: lower bound
* `maxxt`: upper bound

* `model_switch`: associate sampling times with model
]

???


Our initial sampling design.

These define the design space for our sampling times.  When optimizing, potential sampling times will be evaluated between these bounds.

The way we've defined our `ff()` function above, this allows us to signify that the first sampling time is after the first dose (`model_switch == 1`), and the remaining 4 samples are at steady state (`model_switch == 2`).

---

# `create.poped.database()`

.pull-left-60[

```r
poped_db &lt;- create.poped.database(
  ff_fun = ff,
  fg_fun = fg,
  fError_fun = feps.add.prop,
  bpop = c(CL = 10, V = 100, KA = 0.25, WT_CL = 0.75, WT_V = 1),
  notfixed_bpop = c(1, 1, 1, 0, 0),
  d = c(CL = 0.08, V = 0.1, KA = 0.2),
  sigma = c(0.05, 1),
  m = 1,
  groupsize = 12,
  xt = c(5, c(rep(24, 3), 168)),
  minxt = c(0, c(rep(23, 3), 96)),
  maxxt = c(6, c(rep(24, 3), 168)),
  model_switch = c(1, rep(2, 4)),
* a = cbind(DOSE = 10, TAU = 24, WT = 32)
)
```
]

.pull-right-40[
* `a`: covariates
]

???

The "covariates" in our model.  Note that we're using a single body weight here to keep things simple, but we could [use a distribution if necessary](https://cran.r-project.org/web/packages/PopED/vignettes/examples.html#distribution-of-covariates).

---
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
